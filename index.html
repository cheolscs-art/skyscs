<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vintage Real EQ Amp</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- ê¸°ì¡´ ë ˆíŠ¸ë¡œ ì•°í”„ ë””ìì¸ CSS --- */
        * { box-sizing: border-box; user-select: none; }
        body {
            font-family: 'Orbitron', sans-serif;
            background: #222;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .amp-player {
            background: #1a1a1a;
            border: 4px solid #000;
            border-radius: 10px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.9), inset 0 0 20px rgba(255,255,255,0.05);
            padding: 30px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            position: relative;
        }

        .amp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }
        .amp-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #d4af37;
            letter-spacing: 3px;
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
        }
        .power-light {
            width: 12px; height: 12px;
            background: #e74c3c;
            border-radius: 50%;
            box-shadow: 0 0 5px #e74c3c;
            transition: 0.3s;
        }
        .power-light.on {
            background: #2ecc71;
            box-shadow: 0 0 10px #2ecc71, inset 0 0 2px #fff;
        }

        /* ë””ìŠ¤í”Œë ˆì´ ì˜ì—­ (ìº”ë²„ìŠ¤ í¬í•¨) */
        .display-screen-container {
            position: relative;
            width: 100%;
            height: 100px;
            background: #000;
            border: 2px solid #444;
            border-radius: 4px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        /* ë¹„ì£¼ì–¼ë¼ì´ì € ìº”ë²„ìŠ¤ */
        #visualizerCanvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        /* ìŠ¤ìº”ë¼ì¸ ë° í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ */
        .screen-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: monospace;
            color: #33ff33;
            text-shadow: 0 0 5px #33ff33;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            pointer-events: none; /* í´ë¦­ í†µê³¼ */
        }

        #title {
            font-size: 1.1rem;
            margin: 0 0 5px 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 90%;
        }
        .time-display { font-size: 0.9rem; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ (6ê°œ ë…¸ë¸Œ ë ˆì´ì•„ì›ƒ) */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px 15px; /* ìƒí•˜ 20px, ì¢Œìš° 15px */
            margin-bottom: 25px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .control-group label {
            font-size: 0.7rem; color: #888; margin-bottom: 8px; text-transform: uppercase;
        }
        
        .knob-container {
            width: 55px; height: 55px;
            background: #2b2b2b;
            border-radius: 50%;
            border: 2px solid #111;
            position: relative;
            cursor: grab;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.1);
            /* ì´ˆê¸° ê°ë„ ì„¤ì • (ë³¼ë¥¨ì€ -135ë„, EQëŠ” 0ë„ ì¤‘ì•™) */
            transform: rotate(var(--angle, 0deg));
        }
        .knob-container:active { cursor: grabbing; }
        .knob-marker {
            position: absolute; top: 5px; left: 50%;
            transform: translateX(-50%);
            width: 4px; height: 15px;
            background: #d4af37; border-radius: 2px;
        }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group {
            display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .amp-btn {
            background: linear-gradient(to bottom, #444, #222);
            color: #ccc; border: 1px solid #111;
            padding: 10px 20px; border-radius: 4px;
            cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 0.8rem;
            box-shadow: 0 3px 0 #000; transition: transform 0.1s;
        }
        .amp-btn:active { transform: translateY(3px); box-shadow: 0 0 0 #000; }
        .amp-btn.play-btn { color: #2ecc71; border-color: #2ecc71; }
        
        .file-label {
            display: inline-block; background: #d4af37; color: #111;
            padding: 10px 15px; border-radius: 4px; cursor: pointer;
            font-size: 0.8rem; font-weight: bold; box-shadow: 0 3px 0 #8f7524;
        }
        .file-label:active { transform: translateY(3px); box-shadow: none; }

        /* ì§„í–‰ë°” ë° í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ */
        input[type="range"]#progressBar {
            -webkit-appearance: none; width: 100%; height: 6px; background: #333;
            border-radius: 3px; outline: none; margin-bottom: 15px;
        }
        input[type="range"]#progressBar::-webkit-slider-thumb {
            -webkit-appearance: none; width: 15px; height: 15px; background: #d4af37; border-radius: 50%; cursor: pointer;
        }
        .playlist {
            background: #111; border: 1px solid #333; height: 120px; overflow-y: auto;
            border-radius: 4px; text-align: left; padding: 5px;
        }
        .playlist-item {
            padding: 8px; font-size: 0.8rem; border-bottom: 1px solid #222;
            cursor: pointer; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .playlist-item:hover { background: #222; color: #fff; }
        .playlist-item.active { background: #2ecc71; color: #000; font-weight: bold; }
    </style>
</head>
<body>

<div class="amp-player">
    <div class="amp-header">
        <div class="amp-logo">REAL-EQ AMP</div>
        <div class="power-light" id="powerLight"></div>
    </div>

    <div class="display-screen-container">
        <canvas id="visualizerCanvas"></canvas>
        <div class="screen-overlay">
            <h2 id="title">NO AUDIO</h2>
            <div class="time-display">
                <span id="currTime">0:00</span> / <span id="totalTime">0:00</span>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <div class="control-group">
            <label>Master Vol</label>
            <div class="knob-container knob-control" id="knob-vol" data-type="volume" style="--angle: -135deg;">
                <div class="knob-marker"></div>
            </div>
        </div>
        <div class="control-group">
            <label>60Hz (Bass)</label>
            <div class="knob-container knob-control" id="knob-60" data-type="eq" data-index="0" style="--angle: 0deg;">
                <div class="knob-marker"></div>
            </div>
        </div>
        <div class="control-group">
            <label>250Hz</label>
            <div class="knob-container knob-control" id="knob-250" data-type="eq" data-index="1" style="--angle: 0deg;">
                <div class="knob-marker"></div>
            </div>
        </div>
        
        <div class="control-group">
            <label>1kHz (Mid)</label>
            <div class="knob-container knob-control" id="knob-1k" data-type="eq" data-index="2" style="--angle: 0deg;">
                <div class="knob-marker"></div>
            </div>
        </div>
        <div class="control-group">
            <label>4kHz</label>
            <div class="knob-container knob-control" id="knob-4k" data-type="eq" data-index="3" style="--angle: 0deg;">
                <div class="knob-marker"></div>
            </div>
        </div>
        <div class="control-group">
            <label>16kHz (Treble)</label>
            <div class="knob-container knob-control" id="knob-16k" data-type="eq" data-index="4" style="--angle: 0deg;">
                <div class="knob-marker"></div>
            </div>
        </div>
    </div>

    <input type="range" id="progressBar" value="0" max="100">

    <div class="btn-group">
        <button class="amp-btn" id="prevBtn">PREV</button>
        <button class="amp-btn play-btn" id="playBtn">PLAY</button>
        <button class="amp-btn" id="nextBtn">NEXT</button>
    </div>

    <label for="fileInput" class="file-label">ğŸ’¿ INSERT TAPE (Load Files)</label>
    <input type="file" id="fileInput" accept="audio/*" multiple style="display: none;">

    <div class="playlist" id="playlist"></div>
</div>

<audio id="audio" crossorigin="anonymous"></audio>

<script>
    // ===========================
    // 1. ì „ì—­ ë³€ìˆ˜ ë° ìš”ì†Œ ì°¸ì¡°
    // ===========================
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const titleEl = document.getElementById('title');
    const currTimeEl = document.getElementById('currTime');
    const totalTimeEl = document.getElementById('totalTime');
    const progressBar = document.getElementById('progressBar');
    const playlistEl = document.getElementById('playlist');
    const powerLight = document.getElementById('powerLight');
    const canvas = document.getElementById('visualizerCanvas');
    const ctx = canvas.getContext('2d');

    let songList = [];
    let currentIndex = 0;
    let isPlaying = false;

    // Web Audio API ê´€ë ¨ ë³€ìˆ˜
    let audioContext;
    let sourceNode;
    let analyser;
    let eqFilters = [];
    const eqFrequencies = [60, 250, 1000, 4000, 16000]; // 5ë°´ë“œ ì£¼íŒŒìˆ˜
    let isAudioContextInitialized = false;

    // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
    function resizeCanvas() {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); // ì´ˆê¸° ì‹¤í–‰

    // ===========================
    // 2. Web Audio API ì´ˆê¸°í™” (í•µì‹¬)
    // ===========================
    function initAudioContext() {
        if (isAudioContextInitialized) return;

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();

        sourceNode = audioContext.createMediaElementSource(audio);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256; // ë¹„ì£¼ì–¼ë¼ì´ì € í•´ìƒë„

        // EQ í•„í„° ìƒì„± (Peaking Type)
        eqFilters = eqFrequencies.map(freq => {
            const filter = audioContext.createBiquadFilter();
            filter.type = 'peaking';
            filter.frequency.value = freq;
            filter.Q.value = 1.0;
            filter.gain.value = 0; // ì´ˆê¸° ê²Œì¸ 0dB
            return filter;
        });

        // ë…¸ë“œ ì—°ê²°: Source -> EQ1 -> EQ2... -> Analyser -> Destination
        sourceNode.connect(eqFilters[0]);
        for (let i = 0; i < eqFilters.length - 1; i++) {
            eqFilters[i].connect(eqFilters[i + 1]);
        }
        eqFilters[eqFilters.length - 1].connect(analyser);
        analyser.connect(audioContext.destination);

        isAudioContextInitialized = true;
        drawVisualizer(); // ì‹œê°í™” ì‹œì‘
    }

    // ===========================
    // 3. ë¹„ì£¼ì–¼ë¼ì´ì € ê·¸ë¦¬ê¸° (ë…¹ìƒ‰ í…Œë§ˆ)
    // ===========================
    function drawVisualizer() {
        requestAnimationFrame(drawVisualizer);

        if (!isAudioContextInitialized) return;

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const barWidth = (canvas.width / bufferLength) * 2.5;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
            const barHeight = (dataArray[i] / 255) * canvas.height;

            // ë ˆíŠ¸ë¡œ ë…¹ìƒ‰ ê·¸ë¼ë°ì´ì…˜
            const gradient = ctx.createLinearGradient(0, canvas.height, 0, 0);
            gradient.addColorStop(0, 'rgba(0, 255, 0, 0.8)'); // í•˜ë‹¨ ì§„í•œ ë…¹ìƒ‰
            gradient.addColorStop(1, 'rgba(150, 255, 150, 0.5)'); // ìƒë‹¨ ì—°í•œ ë…¹ìƒ‰

            ctx.fillStyle = gradient;
            // ë¶€ë“œëŸ¬ìš´ ë§‰ëŒ€ ê·¸ë¦¬ê¸°
            ctx.fillRect(x, canvas.height - barHeight, barWidth - 1, barHeight);

            x += barWidth;
        }
    }

    // ===========================
    // 4. ë…¸ë¸Œ ì»¨íŠ¸ë¡¤ ë¡œì§ (í†µí•©ë¨)
    // ===========================
    let activeKnob = null;
    const knobElements = document.querySelectorAll('.knob-control');

    knobElements.forEach(knob => {
        knob.addEventListener('mousedown', (e) => {
            activeKnob = knob;
            updateKnobValue(e);
        });
        // EQ ë…¸ë¸Œ ë”ë¸” í´ë¦­ ì‹œ 0dB ë¦¬ì…‹ ê¸°ëŠ¥
        if(knob.dataset.type === 'eq') {
            knob.addEventListener('dblclick', () => {
                resetEqKnob(knob);
            });
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (activeKnob) {
            updateKnobValue(e);
        }
    });

    document.addEventListener('mouseup', () => {
        activeKnob = null;
    });

    function updateKnobValue(e) {
        if (!activeKnob) return;

        const rect = activeKnob.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— ë”°ë¥¸ ê°ë„ ê³„ì‚°
        let deg = Math.atan2(e.clientY - centerY, e.clientX - centerX) * (180 / Math.PI);
        
        // ê°ë„ ë³´ì • ë° 0~1 ë²”ìœ„ ë§¤í•‘ (ì´ 270ë„ ë²”ìœ„ ì‚¬ìš©: -135ë„ ~ +135ë„)
        if (deg < 90) deg += 360; // 12ì‹œ ê¸°ì¤€ ë³´ì •
        let normalizedAngle = deg - 90; // 0ë„ê°€ 12ì‹œê°€ ë˜ë„ë¡
        
        // ìœ íš¨ ë²”ìœ„ ì œí•œ (ì•½ 7ì‹œ ë°©í–¥ ~ 5ì‹œ ë°©í–¥)
        const startAngle = 45; // 7ì‹œ ë°©í–¥ ê·¼ì²˜
        const endAngle = 315;  // 5ì‹œ ë°©í–¥ ê·¼ì²˜
        
        if (normalizedAngle < startAngle) normalizedAngle = startAngle;
        if (normalizedAngle > endAngle) normalizedAngle = endAngle;

        // 0.0 ~ 1.0 ê°’ìœ¼ë¡œ ë³€í™˜
        const ratio = (normalizedAngle - startAngle) / (endAngle - startAngle);
        
        // ì‹¤ì œ ì˜¤ë””ì˜¤ ê¸°ëŠ¥ì— ì ìš©
        const knobType = activeKnob.dataset.type;

        if (knobType === 'volume') {
            // ë³¼ë¥¨: 0 ~ 1 ë²”ìœ„
            audio.volume = ratio;
            // CSS ê°ë„ ì—…ë°ì´íŠ¸ (-135 ~ 135ë„)
            activeKnob.style.setProperty('--angle', `${ratio * 270 - 135}deg`);

        } else if (knobType === 'eq') {
            if (!isAudioContextInitialized) initAudioContext(); // EQ ì¡°ì‘ ì‹œ ì˜¤ë””ì˜¤ ì—”ì§„ ì‹œì‘
            const index = parseInt(activeKnob.dataset.index);
            // EQ ê²Œì¸: -12dB ~ +12dB ë²”ìœ„ë¡œ ë³€í™˜
            const gainValue = (ratio * 24) - 12;
            eqFilters[index].gain.value = gainValue;
             // CSS ê°ë„ ì—…ë°ì´íŠ¸ (-135 ~ 135ë„)
            activeKnob.style.setProperty('--angle', `${ratio * 270 - 135}deg`);
        }
    }

    // EQ ë…¸ë¸Œ ë¦¬ì…‹ í•¨ìˆ˜
    function resetEqKnob(knob) {
        if (!isAudioContextInitialized) initAudioContext();
        const index = parseInt(knob.dataset.index);
        eqFilters[index].gain.value = 0; // 0dBë¡œ ë¦¬ì…‹
        knob.style.setProperty('--angle', `0deg`); // ì¤‘ì•™ìœ¼ë¡œ ë³µê·€
    }


    // ===========================
    // 5. ê¸°ë³¸ í”Œë ˆì´ì–´ ê¸°ëŠ¥ (íŒŒì¼, ì¬ìƒ ë“±)
    // ===========================
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        songList = files;
        currentIndex = 0;
        renderPlaylist();
        loadSong(currentIndex);
        powerLight.classList.add('on');
    });

    function renderPlaylist() {
        playlistEl.innerHTML = '';
        songList.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = `playlist-item ${index === currentIndex ? 'active' : ''}`;
            item.innerText = `${index + 1}. ${file.name}`;
            item.onclick = () => {
                currentIndex = index;
                loadSong(currentIndex);
                playAudio();
            };
            playlistEl.appendChild(item);
        });
    }

    function loadSong(index) {
        if (!songList[index]) return;
        titleEl.innerText = songList[index].name;
        audio.src = URL.createObjectURL(songList[index]);
        progressBar.value = 0;
        currTimeEl.innerText = "0:00"; totalTimeEl.innerText = "0:00";
        renderPlaylist();
    }

    function playAudio() {
        // ì¤‘ìš”: ì‚¬ìš©ì ì¸í„°ë™ì…˜ ì‹œì ì— AudioContext ì‹œì‘/ì¬ê°œ
        if (!isAudioContextInitialized) initAudioContext();
        if (audioContext.state === 'suspended') audioContext.resume();

        audio.play().then(() => {
            isPlaying = true; playBtn.innerText = "PAUSE";
        }).catch(console.error);
    }
    
    playBtn.onclick = () => {
        if (songList.length === 0) return alert("TAPE NOT INSERTED (íŒŒì¼ì„ ì¶”ê°€í•˜ì„¸ìš”)");
        if (isPlaying) { audio.pause(); isPlaying = false; playBtn.innerText = "PLAY"; }
        else playAudio();
    };

    prevBtn.onclick = () => {
        if (songList.length === 0) return;
        currentIndex = (currentIndex - 1 + songList.length) % songList.length;
        loadSong(currentIndex); playAudio();
    };
    nextBtn.onclick = () => {
        if (songList.length === 0) return;
        currentIndex = (currentIndex + 1) % songList.length;
        loadSong(currentIndex); playAudio();
    };

    audio.addEventListener('timeupdate', () => {
        if (!isNaN(audio.duration)) {
            progressBar.value = (audio.currentTime / audio.duration) * 100;
            currTimeEl.innerText = formatTime(audio.currentTime);
            totalTimeEl.innerText = formatTime(audio.duration);
        }
    });
    progressBar.addEventListener('input', () => {
        audio.currentTime = (progressBar.value / 100) * audio.duration;
    });
    audio.addEventListener('ended', () => nextBtn.click());

    function formatTime(s) {
        if (isNaN(s)) return "0:00";
        return `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
    }
    
    // ì´ˆê¸° ë³¼ë¥¨ ë…¸ë¸Œ ìœ„ì¹˜ ë™ê¸°í™”
    updateKnobValue({ clientY: 0, clientX: 0 }); // ë”ë¯¸ ì´ë²¤íŠ¸ë¡œ ì´ˆê¸°í™” íŠ¸ë¦¬ê±° (ì‹¤ì œë¡  ì•„ë˜ ì¤„ì´ ì¤‘ìš”)
    document.getElementById('knob-vol').style.setProperty('--angle', `${audio.volume * 270 - 135}deg`);

</script>
</body>
</html>